<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QQI Award Standards — Browser</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background: #f8f9fa; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .sticky-top-controls { top: 0; z-index: 1020; }
  </style>
</head>

<body>
  <header class="bg-white border-bottom">
    <div class="container py-3">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
        <div>
          <h1 class="h4 mb-1">QQI Award Standards Browser</h1>
          <div class="text-secondary">
            Award Standard is the primary filter. Level / Criteria / Thread filters are populated <em>from the selected standard</em>.
          </div>
        </div>

        <div class="d-flex gap-2">
          <a class="btn btn-outline-primary"
             href="https://www.qqi.ie/what-we-do/qqi-awards/qqi-awards-standards"
             target="_blank" rel="noopener">
            QQI Awards Standards (official)
          </a>
          <button id="btnExport" class="btn btn-primary" disabled>Export filtered CSV</button>
        </div>
      </div>
    </div>
  </header>

  <div class="bg-white border-bottom sticky-top sticky-top-controls">
    <div class="container py-3">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-lg-4">
          <label class="form-label mb-1">Award Standard</label>
          <select id="fStandard" class="form-select">
            <option value="">Select a standard…</option>
          </select>
        </div>

        <div class="col-12 col-lg-8">
          <div class="text-secondary small mt-4" id="pickHint">
            Choose an Award Standard to reveal Level / Criteria / Thread filters.
          </div>
        </div>
      </div>

      <div id="dependentFilters" class="row g-2 align-items-end mt-2 d-none">
        <div class="col-6 col-lg-2">
          <label class="form-label mb-1">NFQ Level</label>
          <select id="fLevel" class="form-select">
            <option value="">All levels</option>
          </select>
        </div>

        <div class="col-6 col-lg-5">
          <label class="form-label mb-1">Criteria</label>
          <select id="fCriteria" class="form-select">
            <option value="">All</option>
          </select>
        </div>

        <div class="col-12 col-lg-4">
          <label class="form-label mb-1">Thread</label>
          <select id="fThread" class="form-select">
            <option value="">All</option>
          </select>
        </div>

        <div class="col-12 col-lg-1">
          <button id="btnClear" class="btn btn-outline-secondary w-100">Clear</button>
        </div>
      </div>

      <div class="mt-3 d-flex flex-column flex-md-row gap-2 align-items-md-center">
        <div id="status" class="text-secondary small">Loading…</div>
        <div class="ms-md-auto d-flex gap-2">
          <span class="badge text-bg-light border" id="countBadge">0</span>
          <span class="badge text-bg-light border" id="uniqueBadge">—</span>
        </div>
      </div>

      <div id="alert" class="alert alert-warning mt-3 d-none" role="alert"></div>
    </div>
  </div>

  <main class="container py-4">
    <div class="card shadow-sm">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:20%">Award Standard</th>
              <th style="width:8%">Level</th>
              <th style="width:24%">Criteria</th>
              <th style="width:20%">Thread</th>
              <th>Descriptor</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const JSON_PATH = "qqi_award_standards.json";

    let model = null;
    let flat = [];
    let filtered = [];

    const $ = (id) => document.getElementById(id);
    const esc = (s) => (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    const norm = (v) => (v ?? "").toString().trim();

    function uniqSorted(arr) {
      const u = Array.from(new Set(arr.map(norm).filter(Boolean)));
      u.sort((a,b) => a.localeCompare(b, undefined, { numeric:true, sensitivity:"base" }));
      return u;
    }

    function setOptions(selectEl, values, allLabel) {
      const current = selectEl.value;
      selectEl.innerHTML = `<option value="">${allLabel}</option>` + values.map(v => `<option value="${esc(v)}">${esc(v)}</option>`).join("");
      if (current && values.includes(current)) selectEl.value = current; else selectEl.value = "";
    }

    function showDependents(show) {
      $("dependentFilters").classList.toggle("d-none", !show);
      $("pickHint").classList.toggle("d-none", show);
      if (!show) { $("fLevel").value = ""; $("fCriteria").value = ""; $("fThread").value = ""; }
    }

    function getStandardByName(name) {
      return (model?.awardStandards ?? []).find(s => norm(s.name) === norm(name)) || null;
    }

    function flattenStandard(stdObj) {
      const rows = [];
      const stdName = stdObj?.name ?? "";
      for (const lvl of (stdObj?.nfqLevels ?? [])) {
        const level = lvl?.level;
        for (const group of (lvl?.indicatorGroups ?? [])) {
          const criteria = group?.name ?? "";
          for (const ind of (group?.indicators ?? [])) {
            const thread = ind?.name ?? "";
            const descriptor = ind?.descriptorText ?? ind?.descriptor ?? "";
            rows.push({
              "Award Standard": stdName,
              "NFQ Level": level,
              "Criteria": criteria,
              "Thread": thread,
              "Descriptor": descriptor,
              "Descriptor Source": ind?.descriptorText ? "descriptorText" : "descriptor",
              "Id": ind?.id ?? ""
            });
          }
        }
      }
      return rows;
    }

    function populateStandardDropdown() {
      const names = uniqSorted((model?.awardStandards ?? []).map(s => s.name));
      setOptions($("fStandard"), names, "Select a standard…");
    }

    function populateDependentsForStandard(stdObj) {
      flat = flattenStandard(stdObj);
      setOptions($("fLevel"), uniqSorted(flat.map(r => String(r["NFQ Level"]))), "All levels");
      setOptions($("fCriteria"), uniqSorted(flat.map(r => r["Criteria"])), "All");
      setOptions($("fThread"), uniqSorted(flat.map(r => r["Thread"])), "All");
    }

    function applyFilters() {
      const std = $("fStandard").value;
      const rowsEl = $("rows");

      if (!std) {
        filtered = []; flat = [];
        rowsEl.innerHTML = "";
        $("status").textContent = "Select an Award Standard to view standards descriptors.";
        $("countBadge").textContent = "0";
        $("uniqueBadge").textContent = "—";
        $("btnExport").disabled = true;
        return;
      }

      const level = $("fLevel").value;
      const criteria = $("fCriteria").value;
      const thread = $("fThread").value;

      filtered = flat.filter(r => {
        if (level && String(r["NFQ Level"]) !== level) return false;
        if (criteria && norm(r["Criteria"]) !== norm(criteria)) return false;
        if (thread && norm(r["Thread"]) !== norm(thread)) return false;
        return true;
      });

      render(); updateStatus();
      $("btnExport").disabled = (filtered.length === 0);
    }

    function render() {
      const rowsEl = $("rows");
      rowsEl.innerHTML = "";
      const max = Math.min(filtered.length, 800);

      for (let i=0; i<max; i++) {
        const r = filtered[i];
        const badge = r["Descriptor Source"] === "descriptorText"
          ? `<span class="badge text-bg-warning ms-2" title="Uses descriptorText">alt</span>` : ``;

        rowsEl.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${esc(r["Award Standard"])}</td>
            <td><span class="badge text-bg-info">${esc(String(r["NFQ Level"]))}</span></td>
            <td>${esc(r["Criteria"])}</td>
            <td>${esc(r["Thread"])}</td>
            <td class="truncate-2">${esc(r["Descriptor"])} ${badge}</td>
          </tr>
        `);
      }

      if (filtered.length > max) {
        rowsEl.insertAdjacentHTML("beforeend", `
          <tr><td colspan="5" class="text-secondary small">
            Showing first ${max} results. Narrow filters to reduce.
          </td></tr>
        `);
      }
    }

    function updateStatus() {
      $("status").textContent = `Showing ${filtered.length.toLocaleString()} rows.`;
      $("countBadge").textContent = filtered.length.toLocaleString();
      const uLevels = new Set(filtered.map(r => String(r["NFQ Level"])) ).size;
      const uCriteria = new Set(filtered.map(r => norm(r["Criteria"])) ).size;
      $("uniqueBadge").textContent = `${uLevels} levels • ${uCriteria} criteria`;
    }

    function toCsv(rows) {
      const cols = ["Award Standard","NFQ Level","Criteria","Thread","Descriptor","Descriptor Source","Id"];
      const q = (v) => `"${(v ?? "").toString().replaceAll('"','""')}"`;
      const lines = [cols.map(q).join(",")];
      for (const r of rows) lines.push(cols.map(c => q(r[c])).join(","));
      return lines.join("\n");
    }

    $("btnExport").addEventListener("click", () => {
      const csv = toCsv(filtered);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "qqi_award_standards_filtered.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    $("btnClear").addEventListener("click", () => {
      $("fLevel").value = ""; $("fCriteria").value = ""; $("fThread").value = "";
      applyFilters();
    });

    $("fStandard").addEventListener("change", () => {
      const name = $("fStandard").value;
      const stdObj = getStandardByName(name);
      showDependents(!!stdObj);
      if (stdObj) populateDependentsForStandard(stdObj);
      applyFilters();
    });

    ["fLevel","fCriteria","fThread"].forEach(id => $(id).addEventListener("change", applyFilters));

    async function init() {
      try {
        const res = await fetch(JSON_PATH, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status} loading ${JSON_PATH}`);
        const json = await res.json();
        if (!json || !Array.isArray(json.awardStandards)) throw new Error("JSON shape unexpected. Expected { awardStandards: [...] }.");
        model = json;
        populateStandardDropdown();
        showDependents(false);
        applyFilters();
        $("alert").classList.add("d-none");
      } catch (e) {
        $("alert").classList.remove("d-none");
        $("alert").innerHTML = `
          <strong>Could not load JSON.</strong><br>
          Ensure <span class="mono">${esc(JSON_PATH)}</span> is present beside <span class="mono">index.html</span>.<br>
          <div class="mt-2 mono small">${esc(e.message || String(e))}</div>
        `;
        $("status").textContent = "Failed to load.";
      }
    }
    init();
  </script>
</body>
</html>
